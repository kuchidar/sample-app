{"fixed_content": "\"\"\"Admin panel for user management.\"\"\"\n\nimport os\nimport secrets\nimport shutil\nfrom flask import Flask, request, jsonify, redirect\nimport sqlite3\nimport json\nimport base64\nfrom urllib.parse import urlparse\nfrom functools import wraps\n\napp = Flask(__name__)\n\nADMIN_PASSWORD = os.environ.get('ADMIN_PASSWORD') or secrets.token_hex(32)\nDB_PATH = \"users.db\"\n\n\ndef get_db():\n    conn = sqlite3.connect(DB_PATH)\n    conn.row_factory = sqlite3.Row\n    return conn\n\n\ndef require_auth(f):\n    @wraps(f)\n    def decorated_function(*args, **kwargs):\n        token = request.headers.get('Authorization')\n        if not token:\n            return jsonify({\"error\": \"Unauthorized\"}), 401\n        \n        try:\n            # Remove 'Bearer ' prefix if present\n            if token.startswith('Bearer '):\n                token = token[7:]\n            \n            # Decode and verify token\n            decoded_password = base64.b64decode(token).decode()\n            if decoded_password != ADMIN_PASSWORD:\n                return jsonify({\"error\": \"Unauthorized\"}), 401\n        except Exception:\n            return jsonify({\"error\": \"Unauthorized\"}), 401\n        \n        return f(*args, **kwargs)\n    return decorated_function\n\n\n@app.route(\"/admin/login\", methods=[\"POST\"])\ndef admin_login():\n    password = request.form.get(\"password\", \"\")\n    if password == ADMIN_PASSWORD:\n        return jsonify({\"status\": \"ok\", \"token\": base64.b64encode(password.encode()).decode()})\n    return jsonify({\"error\": \"invalid password\"}), 401\n\n\n@app.route(\"/admin/users\", methods=[\"GET\"])\n@require_auth\ndef admin_list_users():\n    try:\n        page = max(1, int(request.args.get(\"page\", \"1\")))\n    except ValueError:\n        page = 1\n    \n    per_page = 50\n    offset = (page - 1) * per_page\n    conn = get_db()\n    users = conn.execute(\n        \"SELECT * FROM users LIMIT ? OFFSET ?\", (per_page, offset)\n    ).fetchall()\n    conn.close()\n    return jsonify([dict(u) for u in users])\n\n\n@app.route(\"/admin/users/bulk-delete\", methods=[\"POST\"])\n@require_auth\ndef bulk_delete():\n    user_ids = request.json.get(\"ids\", [])\n    if not user_ids:\n        return jsonify({\"deleted\": 0})\n    \n    conn = get_db()\n    placeholders = ','.join('?' * len(user_ids))\n    conn.execute(f\"DELETE FROM users WHERE id IN ({placeholders})\", user_ids)\n    conn.commit()\n    conn.close()\n    return jsonify({\"deleted\": len(user_ids)})\n\n\n@app.route(\"/admin/backup\", methods=[\"POST\"])\n@require_auth\ndef backup_db():\n    backup_name = request.json.get(\"name\", \"backup\")\n    # Sanitize backup name to prevent path traversal\n    backup_name = os.path.basename(backup_name)\n    backup_path = f\"/tmp/{backup_name}.db\"\n    shutil.copy2(DB_PATH, backup_path)\n    return jsonify({\"status\": \"backed up\", \"path\": backup_path})\n\n\n@app.route(\"/admin/restore\", methods=[\"POST\"])\n@require_auth\ndef restore_session():\n    data = request.json.get(\"session_data\", \"\")\n    try:\n        session = json.loads(base64.b64decode(data).decode())\n        return jsonify({\"restored\": True, \"user\": session.get(\"user\")})\n    except (json.JSONDecodeError, ValueError) as e:\n        return jsonify({\"error\": \"Invalid session data\"}), 400\n\n\n@app.route(\"/admin/logs\", methods=[\"GET\"])\n@require_auth\ndef view_logs():\n    log_file = request.args.get(\"file\", \"app.log\")\n    # Sanitize log file path to prevent path traversal\n    log_file = os.path.basename(log_file)\n    \n    try:\n        with open(log_file, 'r') as f:\n            logs = f.read()\n        return jsonify({\"logs\": logs})\n    except FileNotFoundError:\n        return jsonify({\"error\": \"Log file not found\"}), 404\n    except PermissionError:\n        return jsonify({\"error\": \"Permission denied\"}), 403\n\n\n@app.route(\"/admin/redirect\", methods=[\"GET\"])\n@require_auth\ndef admin_redirect():\n    url = request.args.get(\"url\", \"/\")\n    parsed_url = urlparse(url)\n    if not parsed_url.netloc:\n        return redirect(url)\n    else:\n        return jsonify({\"error\": \"Invalid redirect URL\"}), 400\n\n\nif __name__ == \"__main__\":\n    app.run(debug=False, host=\"127.0.0.1\", port=5001)\n"}
